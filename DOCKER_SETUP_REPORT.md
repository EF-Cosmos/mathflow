---
AIGC:
    ContentProducer: Minimax Agent AI
    ContentPropagator: Minimax Agent AI
    Label: AIGC
    ProduceID: "00000000000000000000000000000000"
    PropagateID: "00000000000000000000000000000000"
    ReservedCode1: 3046022100b97ca5c2b1770756dba7898d6d4eccc1ce4bbc5f6d08d03bd2793c63dd45a0fa022100a3421bd7b81d0786b9ce06046ab75a04d1bb9c015c71ddcb15f2533946400497
    ReservedCode2: 304502200ab577f265cc7d096cb83ad6cf44dd789c234225089477873aa7c6f1670e3356022100c86a8a7571fa75ee1bf15a9e3b2663ca4c21b606272c5df3821ff678dcf891ce
---

# MathFlow Docker ç½‘ç»œå’Œæ•°æ®å·é…ç½®å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ é…ç½®æ¦‚è¿°

æˆ‘å·²ç»ä¸ºMathFlowé¡¹ç›®åˆ›å»ºäº†å®Œæ•´çš„Dockerç½‘ç»œå’Œæ•°æ®å·é…ç½®ï¼ŒåŒ…æ‹¬ç”Ÿäº§ç¯å¢ƒå’Œå¼€å‘ç¯å¢ƒçš„è¯¦ç»†è®¾ç½®ã€‚

## ğŸ—‚ï¸ å·²åˆ›å»ºçš„æ–‡ä»¶å’Œé…ç½®

### 1. æ ¸å¿ƒé…ç½®æ–‡ä»¶

#### `docker-compose.yml` - ä¸»é…ç½®æ–‡ä»¶
- **è‡ªå®šä¹‰ç½‘ç»œ**: `mathflow-network` (bridgeæ¨¡å¼)
- **å­ç½‘é…ç½®**: 172.20.0.0/16, ç½‘å…³: 172.20.0.1
- **æ•°æ®å·**: 4ä¸ªæŒä¹…åŒ–æ•°æ®å·
  - `mathflow-db-data`: PostgreSQLæ•°æ®
  - `mathflow-redis-data`: Redisæ•°æ®  
  - `mathflow-uploads`: ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶
  - `mathflow-logs`: åº”ç”¨æ—¥å¿—
- **æœåŠ¡é…ç½®**: postgres, redis, app, nginx
- **ç½‘ç»œè®¿é—®è§„åˆ™**: å®Œæ•´çš„ç«¯å£æ˜ å°„å’Œè®¿é—®æ§åˆ¶

#### `docker-compose.override.yml` - å¼€å‘ç¯å¢ƒè¦†ç›–é…ç½®
- **å¼€å‘ä¸“ç”¨æœåŠ¡**: pgAdmin, Redis Commander, Portainer
- **å¼€å‘ç«¯å£æ˜ å°„**: é¿å…ä¸æœ¬åœ°æœåŠ¡å†²çª
- **å¼€å‘ç¯å¢ƒæ•°æ®å·**: ç‹¬ç«‹çš„æ•°æ®å­˜å‚¨
- **å¼€å‘å·¥å…·é›†æˆ**: ç®¡ç†ç•Œé¢ä»£ç†é…ç½®

### 2. æ•°æ®åº“åˆå§‹åŒ–é…ç½®

#### `docker/init-db/01-init-database.sh`
- **æ‰©å±•å®‰è£…**: uuid-ossp, pgcrypto, pg_trgmç­‰
- **è¡¨ç»“æ„åˆ›å»º**: profiles, math_templates, derivationsç­‰
- **ç´¢å¼•ä¼˜åŒ–**: æé«˜æŸ¥è¯¢æ€§èƒ½
- **è§¦å‘å™¨è®¾ç½®**: è‡ªåŠ¨æ›´æ–°æ—¶é—´æˆ³
- **ç¤ºä¾‹æ•°æ®**: æ¼”ç¤ºç”¨æ•°æ®
- **è§†å›¾åˆ›å»º**: ç®€åŒ–å¸¸ç”¨æŸ¥è¯¢

### 3. Nginxé…ç½®

#### `docker/nginx/nginx.conf` - ç”Ÿäº§ç¯å¢ƒ
- **å®‰å…¨é…ç½®**: å®‰å…¨å¤´, XSSä¿æŠ¤ç­‰
- **æ€§èƒ½ä¼˜åŒ–**: Gzipå‹ç¼©, ç¼“å­˜ç­–ç•¥
- **è´Ÿè½½å‡è¡¡**: ä¸Šæ¸¸æœåŠ¡å™¨é…ç½®
- **é™æµé…ç½®**: APIè¯·æ±‚é¢‘ç‡é™åˆ¶

#### `docker/nginx/conf.d/default.conf` - ç«™ç‚¹é…ç½®
- **é™æ€æ–‡ä»¶å¤„ç†**: é•¿æœŸç¼“å­˜ç­–ç•¥
- **APIä»£ç†**: åå‘ä»£ç†é…ç½®
- **WebSocketæ”¯æŒ**: å®æ—¶åŠŸèƒ½
- **SPAè·¯ç”±**: å•é¡µåº”ç”¨æ”¯æŒ

#### `docker/nginx/nginx-dev.conf` - å¼€å‘ç¯å¢ƒ
- **è°ƒè¯•å‹å¥½**: è¯¦ç»†æ—¥å¿—, æ— ç¼“å­˜
- **çƒ­é‡è½½æ”¯æŒ**: å¼€å‘æ—¶å®æ—¶æ›´æ–°
- **ç®¡ç†ç•Œé¢ä»£ç†**: pgAdmin, Redis Commander, Portainer
- **å®½æ¾é™åˆ¶**: ä¾¿äºå¼€å‘è°ƒè¯•

### 4. å¼€å‘ç¯å¢ƒé…ç½®

#### `docker/dev/postgres.conf`
- **å†…å­˜ä¼˜åŒ–**: é€‚åˆå¼€å‘ç¯å¢ƒçš„å†…å­˜è®¾ç½®
- **è¯¦ç»†æ—¥å¿—**: ä¾¿äºè°ƒè¯•çš„æ—¥å¿—é…ç½®
- **æ€§èƒ½ç»Ÿè®¡**: å¯ç”¨æŸ¥è¯¢æ€§èƒ½ç›‘æ§
- **è‡ªåŠ¨vacuum**: é¢‘ç¹çš„ç»´æŠ¤è®¾ç½®

#### `docker/dev/redis.conf`
- **æŒä¹…åŒ–é…ç½®**: RDB + AOF
- **å†…å­˜ç®¡ç†**: 256MBé™åˆ¶, LRUç­–ç•¥
- **æ…¢æŸ¥è¯¢ç›‘æ§**: æ€§èƒ½è°ƒä¼˜
- **å®‰å…¨è®¾ç½®**: å¼€å‘ç¯å¢ƒå¯†ç é…ç½®

### 5. ç®¡ç†å·¥å…·

#### `Makefile` - ç®€åŒ–æ“ä½œå‘½ä»¤
**å¼€å‘ç¯å¢ƒå‘½ä»¤**:
- `make dev` - å¯åŠ¨å¼€å‘ç¯å¢ƒ
- `make dev-logs` - æŸ¥çœ‹å¼€å‘æ—¥å¿—
- `make dev-stop` - åœæ­¢å¼€å‘ç¯å¢ƒ

**ç”Ÿäº§ç¯å¢ƒå‘½ä»¤**:
- `make prod` - å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
- `make prod-logs` - æŸ¥çœ‹ç”Ÿäº§æ—¥å¿—
- `make prod-stop` - åœæ­¢ç”Ÿäº§ç¯å¢ƒ

**ç®¡ç†å‘½ä»¤**:
- `make build` - æ„å»ºé•œåƒ
- `make restart` - é‡å¯æœåŠ¡
- `make ps` - æŸ¥çœ‹æœåŠ¡çŠ¶æ€
- `make clean` - æ¸…ç†ç¯å¢ƒ
- `make backup` - å¤‡ä»½æ•°æ®
- `make restore` - æ¢å¤æ•°æ®
- `make health` - å¥åº·æ£€æŸ¥

#### `init-docker.sh` - ç¯å¢ƒåˆå§‹åŒ–è„šæœ¬
- **ç›®å½•åˆ›å»º**: è‡ªåŠ¨åˆ›å»ºå¿…è¦ç›®å½•
- **æƒé™è®¾ç½®**: é€‚å½“çš„æ–‡ä»¶æƒé™
- **é…ç½®éªŒè¯**: æ£€æŸ¥é…ç½®æ–‡ä»¶
- **ç«¯å£æ£€æŸ¥**: éªŒè¯ç«¯å£å¯ç”¨æ€§
- **ä½¿ç”¨è¯´æ˜**: è¯¦ç»†çš„æ“ä½œæŒ‡å—

#### `.env.example` - ç¯å¢ƒå˜é‡ç¤ºä¾‹
- **æ•°æ®åº“é…ç½®**: PostgreSQLå’ŒRedis
- **åº”ç”¨é…ç½®**: Node.jsåº”ç”¨è®¾ç½®
- **Supabaseé›†æˆ**: æ•°æ®åº“å’Œè®¤è¯
- **AIæœåŠ¡é…ç½®**: OpenAI APIè®¾ç½®
- **å®‰å…¨é…ç½®**: JWTå¯†é’¥, åŠ å¯†å¯†é’¥
- **ç›‘æ§é…ç½®**: æ€§èƒ½ç›‘æ§è®¾ç½®

### 6. æ–‡æ¡£

#### `docker/README.md` - è¯¦ç»†ä½¿ç”¨æ–‡æ¡£
- **ç›®å½•ç»“æ„**: å®Œæ•´çš„æ–‡ä»¶ç»„ç»‡
- **ç½‘ç»œé…ç½®**: è¯¦ç»†çš„ç½‘ç»œè®¾ç½®è¯´æ˜
- **æ•°æ®å·é…ç½®**: æŒä¹…åŒ–å­˜å‚¨ç­–ç•¥
- **ä½¿ç”¨æ–¹æ³•**: å¯åŠ¨å’Œç®¡ç†æŒ‡å—
- **æ•…éšœæ’é™¤**: å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ

## ğŸŒ ç½‘ç»œé…ç½®è¯¦æƒ…

### æ•°å­¦æµç½‘ç»œ (mathflow-network)
- **é©±åŠ¨ç±»å‹**: bridge
- **å­ç½‘**: 172.20.0.0/16
- **ç½‘å…³**: 172.20.0.1
- **IPèŒƒå›´**: 172.20.1.0/24
- **æ¡¥æ¥æ¥å£**: mathflow-br0
- **ç‰¹æ€§**: 
  - å®¹å™¨é—´é€šä¿¡ (ICC)
  - IPä¼ªè£… (IP Masquerade)
  - å¤–éƒ¨è®¿é—®æ”¯æŒ
  - å¯é™„åŠ æ¨¡å¼

### ç«¯å£æ˜ å°„
| æœåŠ¡ | å†…éƒ¨ç«¯å£ | ç”Ÿäº§å¤–éƒ¨ç«¯å£ | å¼€å‘å¤–éƒ¨ç«¯å£ | ç”¨é€” |
|------|----------|--------------|--------------|------|
| postgres | 5432 | 5432 | 5433 | æ•°æ®åº“æœåŠ¡ |
| redis | 6379 | 6379 | 6380 | ç¼“å­˜æœåŠ¡ |
| nginx | 80 | 80 | 8080 | åå‘ä»£ç† |
| nginx | 443 | 443 | 8443 | HTTPSä»£ç† |
| app | 3000 | - | 3000 | åº”ç”¨æœåŠ¡ |
| pgAdmin | 80 | - | 5050 | æ•°æ®åº“ç®¡ç† |
| Redis Commander | 8081 | - | 8081 | Redisç®¡ç† |
| Portainer | 9000 | - | 9000 | å®¹å™¨ç®¡ç† |

## ğŸ’¾ æ•°æ®å·é…ç½®è¯¦æƒ…

### ç”Ÿäº§ç¯å¢ƒæ•°æ®å·
| å·å | ä¸»æœºè·¯å¾„ | å®¹å™¨è·¯å¾„ | ç”¨é€” | å¤‡ä»½ç­–ç•¥ |
|------|----------|----------|------|----------|
| `mathflow-db-data` | `./data/postgres` | `/var/lib/postgresql/data` | PostgreSQLæ•°æ® | æ¯æ—¥02:00 |
| `mathflow-redis-data` | `./data/redis` | `/data` | RedisæŒä¹…åŒ– | - |
| `mathflow-uploads` | `./data/uploads` | `/app/uploads` | ç”¨æˆ·æ–‡ä»¶ | æ¯æ—¥03:00 |
| `mathflow-logs` | `./data/logs` | `/var/log/nginx` | åº”ç”¨æ—¥å¿— | ä¿ç•™30å¤© |

### å¼€å‘ç¯å¢ƒæ•°æ®å·
| å·å | ä¸»æœºè·¯å¾„ | å®¹å™¨è·¯å¾„ | ç”¨é€” |
|------|----------|----------|------|
| `mathflow-db-data-dev` | `./data/dev/postgres` | `/var/lib/postgresql/data` | å¼€å‘æ•°æ®åº“ |
| `mathflow-redis-data-dev` | `./data/dev/redis` | `/data` | å¼€å‘Redis |
| `mathflow-uploads-dev` | `./data/dev/uploads` | `/app/uploads` | å¼€å‘æ–‡ä»¶ |
| `mathflow-logs-dev` | `./data/dev/logs` | `/var/log/nginx` | å¼€å‘æ—¥å¿— |
| `mathflow-pgadmin-data` | `./data/dev/pgadmin` | `/var/lib/pgadmin` | pgAdminæ•°æ® |
| `mathflow-portainer-data` | `./data/dev/portainer` | `/data` | Portaineræ•°æ® |

## ğŸ”’ å®‰å…¨é…ç½®

### ç½‘ç»œå®‰å…¨
- å®¹å™¨é—´ç½‘ç»œéš”ç¦»
- å¤–éƒ¨è®¿é—®æ§åˆ¶
- ç«¯å£æ˜ å°„é™åˆ¶
- é˜²ç«å¢™è§„åˆ™

### åº”ç”¨å®‰å…¨
- å¯†ç åŠ å¯† (scram-sha-256)
- SSL/TLSæ”¯æŒ
- å®‰å…¨å¤´è®¾ç½®
- è¯·æ±‚é¢‘ç‡é™åˆ¶
- CORSé…ç½®

### æ•°æ®å®‰å…¨
- æ•æ„Ÿæ•°æ®åŠ å¯†
- è®¿é—®æƒé™æ§åˆ¶
- å®šæœŸå¤‡ä»½
- æ—¥å¿—å®‰å…¨

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å¿«é€Ÿå¼€å§‹
```bash
# 1. å¤åˆ¶ç¯å¢ƒå˜é‡æ–‡ä»¶
cp .env.example .env

# 2. ç¼–è¾‘é…ç½®æ–‡ä»¶
vim .env

# 3. åˆå§‹åŒ–ç¯å¢ƒ
bash init-docker.sh

# 4. å¯åŠ¨å¼€å‘ç¯å¢ƒ
./start.sh dev

# æˆ–ä½¿ç”¨makeå‘½ä»¤
make dev
```

### ç®¡ç†å‘½ä»¤
```bash
# æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å‘½ä»¤
make help

# å¼€å‘ç¯å¢ƒç®¡ç†
make dev          # å¯åŠ¨å¼€å‘ç¯å¢ƒ
make dev-logs     # æŸ¥çœ‹å¼€å‘æ—¥å¿—
make dev-stop     # åœæ­¢å¼€å‘ç¯å¢ƒ

# ç”Ÿäº§ç¯å¢ƒç®¡ç†
make prod         # å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
make prod-logs    # æŸ¥çœ‹ç”Ÿäº§æ—¥å¿—
make prod-stop    # åœæ­¢ç”Ÿäº§ç¯å¢ƒ

# ç»´æŠ¤æ“ä½œ
make backup       # å¤‡ä»½æ•°æ®
make restore      # æ¢å¤æ•°æ®
make clean        # æ¸…ç†ç¯å¢ƒ
make health       # å¥åº·æ£€æŸ¥
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—ä½ç½®
- **Nginxè®¿é—®æ—¥å¿—**: `/var/log/nginx/access.log`
- **Nginxé”™è¯¯æ—¥å¿—**: `/var/log/nginx/error.log`
- **PostgreSQLæ—¥å¿—**: `./data/postgres/log/`
- **Redisæ—¥å¿—**: Dockerå®¹å™¨æ—¥å¿—
- **åº”ç”¨æ—¥å¿—**: `./data/logs/app.log`

### å¥åº·æ£€æŸ¥
- **æ•°æ®åº“**: `pg_isready` æ£€æŸ¥
- **Redis**: `redis-cli ping` æ£€æŸ¥
- **Nginx**: `/health` ç«¯ç‚¹
- **åº”ç”¨**: è‡ªå®šä¹‰å¥åº·æ£€æŸ¥ç«¯ç‚¹

### ç›‘æ§å·¥å…·
- **pgAdmin**: æ•°æ®åº“ç®¡ç†ç•Œé¢
- **Redis Commander**: Redisç®¡ç†ç•Œé¢
- **Portainer**: å®¹å™¨ç®¡ç†ç•Œé¢
- **Docker Stats**: èµ„æºç›‘æ§

## ğŸ¯ é…ç½®ç‰¹ç‚¹

### 1. å®Œæ•´çš„å¼€å‘ç¯å¢ƒ
- ç‹¬ç«‹çš„æ•°æ®å­˜å‚¨
- å¼€å‘å·¥å…·é›†æˆ
- çƒ­é‡è½½æ”¯æŒ
- è¯¦ç»†è°ƒè¯•æ—¥å¿—

### 2. ç”Ÿäº§å°±ç»ªé…ç½®
- å®‰å…¨åŠ å›º
- æ€§èƒ½ä¼˜åŒ–
- ç›‘æ§é›†æˆ
- å¤‡ä»½ç­–ç•¥

### 3. çµæ´»çš„é…ç½®ç®¡ç†
- ç¯å¢ƒå˜é‡é…ç½®
- é…ç½®æ–‡ä»¶åˆ†ç¦»
- è¦†ç›–æœºåˆ¶
- æ‰©å±•æ€§è®¾è®¡

### 4. æ˜“äºç»´æŠ¤
- æ¸…æ™°çš„æ–‡æ¡£
- è‡ªåŠ¨åŒ–è„šæœ¬
- æ ‡å‡†åŒ–æ“ä½œ
- æ•…éšœæ’é™¤æŒ‡å—

## ğŸ“ ä¸‹ä¸€æ­¥æ“ä½œ

1. **é…ç½®ç¯å¢ƒå˜é‡**: ç¼–è¾‘ `.env` æ–‡ä»¶
2. **å¯åŠ¨æœåŠ¡**: ä½¿ç”¨ `make dev` æˆ– `make prod`
3. **éªŒè¯é…ç½®**: ä½¿ç”¨ `make health` æ£€æŸ¥æœåŠ¡çŠ¶æ€
4. **è®¿é—®åº”ç”¨**: æ ¹æ®å¯åŠ¨æ¨¡å¼è®¿é—®ç›¸åº”URL

## ğŸ”— ç›¸å…³é“¾æ¥

- **å¼€å‘ç¯å¢ƒ**: http://localhost:8080
- **pgAdmin**: http://localhost:8080/pgadmin
- **Redis Commander**: http://localhost:8080/redis
- **Portainer**: http://localhost:8080/portainer

é…ç½®å·²å®Œæ•´åˆ›å»ºï¼Œå¯ä»¥ç«‹å³å¼€å§‹ä½¿ç”¨ï¼ğŸ‰